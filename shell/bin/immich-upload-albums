#!/usr/bin/env bash
# shellcheck shell=bash
set -e

# Script to upload Google Photos takeout folders to Immich as albums
# Usage: immich-upload-albums [base_directory]

BASE_DIR="${1:-$(pwd)}"

if [[ ! -d "$BASE_DIR" ]]; then
    echo "Error: Directory '$BASE_DIR' does not exist" >&2
    exit 1
fi

echo "Processing folders in: $BASE_DIR"
echo "----------------------------------------"

# Find all directories (excluding hidden ones starting with .)
find "$BASE_DIR" -maxdepth 1 -type d ! -name ".*" ! -path "$BASE_DIR" -print0 | while IFS= read -r -d '' folder; do
    folder_name=$(basename "$folder")
    
    echo "Processing album: $folder_name"
    
    # Change to the folder and run the npx command
    if cd "$folder"; then
        if npx @immich/cli upload --album-name "$folder_name" .; then
            echo "✓ Successfully uploaded: $folder_name"
        else
            echo "✗ Failed to upload: $folder_name" >&2
        fi
        cd "$BASE_DIR"
    else
        echo "✗ Failed to enter directory: $folder_name" >&2
    fi
    
    echo "----------------------------------------"
done

echo "Upload process completed!"